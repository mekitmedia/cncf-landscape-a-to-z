{{ define "main" }}
{{ $current := partial "get-current-week.html" . }}
<div class="min-h-screen bg-slate-50 font-sans text-slate-900">
    <!-- Navigation Header -->
    {{ partial "nav.html" . }}

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Progress Tracker -->
        {{ partial "progress.html" (dict "context" . "current" $current) }}

        <!-- Hero Section -->
        {{ partial "hero.html" (dict "context" . "current" $current) }}

        <!-- Tools Section -->
        {{ partial "tools-grid.html" (dict "context" . "current" $current) }}

        <!-- Recent Blog Posts -->
        {{ partial "recent-posts.html" . }}

        <!-- Navigation Footer -->
        {{ partial "homepage-footer.html" . }}
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        let currentLetter = '{{ $current.letter }}';
        let progress = {{ add $current.index 1 }}; // Correct progress based on current index

        const alphabetContainer = document.getElementById('alphabet-container');
        const progressText = document.getElementById('progress-text');

        function handleLetterClick(letter, idx) {
            currentLetter = letter;
            progress = idx + 1;
            // Navigate to the letter page to load new data
            window.location.href = `/letters/${letter.toLowerCase()}/`;
            renderAlphabet();
        }

        function renderAlphabet() {
            alphabetContainer.innerHTML = '';
            alphabet.forEach((letter, idx) => {
                const isActive = letter === currentLetter;
                const isCompleted = idx + 1 < progress;
                const isLocked = idx + 1 > progress;

                const btn = document.createElement('button');
                btn.textContent = letter;

                let classes = "flex-shrink-0 w-10 h-10 rounded-lg font-bold text-sm transition-all ";
                if (isActive) {
                    classes += "bg-blue-600 text-white shadow-lg shadow-blue-200 scale-110";
                } else if (isCompleted) {
                    classes += "bg-blue-100 text-blue-600 border border-blue-200";
                } else if (isLocked) {
                    classes += "bg-slate-50 text-slate-300 border border-slate-100 cursor-not-allowed";
                    btn.disabled = true;
                    btn.title = "Locked - Available in a future week";
                } else {
                    classes += "bg-white text-slate-400 border border-slate-200 hover:border-blue-300 hover:text-blue-500";
                }
                btn.className = classes;

                if (!isLocked) {
                    btn.onclick = () => {
                        handleLetterClick(letter, idx);
                    };
                }

                alphabetContainer.appendChild(btn);
            });
            progressText.textContent = `${Math.round((progress / 26) * 100)}% Complete`;
        }

        function updateView(letter) {
            ['current-letter-hero', 'current-letter-desc', 'current-letter-btn', 'current-letter-stat', 'current-letter-featured', 'bg-letter'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.textContent = letter;
            });

            const deepDiveLink = document.getElementById('deep-dive-link');
            if(deepDiveLink) {
                deepDiveLink.href = `/letters/${letter.toLowerCase()}/`;
            }

            const currentLetterIdx = document.getElementById('current-letter-idx');
            if(currentLetterIdx) {
                currentLetterIdx.textContent = alphabet.indexOf(letter) + 1;
            }

            // Re-initialize icons just in case (though not strictly needed if DOM not changing)
            // lucide.createIcons();

            // In a real implementation, this would fetch new tool data.
        }

        renderAlphabet();

        const countdownEl = document.getElementById('countdown');
        
        // Calculate total seconds until next rotation (every 2 weeks)
        const now = new Date();
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const dayOfYear = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24)) + 1;
        const weekNum = Math.floor((dayOfYear + 6) / 7);
        const twoWeekPeriod = Math.floor((weekNum - 1) / 2);
        const nextRotationWeek = (twoWeekPeriod + 1) * 2 + 1;
        const nextRotationDate = new Date(now.getFullYear(), 0, 1 + (nextRotationWeek - 1) * 7);
        
        let totalSeconds = Math.max(0, Math.floor((nextRotationDate - now) / 1000));

        function updateCountdown() {
             if(totalSeconds > 0) {
                totalSeconds--;
                const d = Math.floor(totalSeconds / (24 * 3600));
                const h = Math.floor((totalSeconds % (24 * 3600)) / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = totalSeconds % 60;
                if (countdownEl) {
                    countdownEl.textContent = `${d}d ${h}h ${m}m ${s}s`;
                }
             } else {
                if (countdownEl) {
                    countdownEl.textContent = "Rotating...";
                }
             }
        }
        
        setInterval(updateCountdown, 1000);
        updateCountdown();

        // Navigation buttons footer
        document.getElementById('prev-btn').onclick = () => {
            const currentIdx = alphabet.indexOf(currentLetter);
            if (currentIdx > 0) {
                const prevLetter = alphabet[currentIdx-1];
                window.location.href = `/letters/${prevLetter.toLowerCase()}/`;
            }
        };

        document.getElementById('next-btn').onclick = () => {
            const currentIdx = alphabet.indexOf(currentLetter);
            if (currentIdx < alphabet.length - 1) {
                // Only allow navigating to next letter if it is not locked
                if (currentIdx + 1 < progress) {
                    const nextLetter = alphabet[currentIdx+1];
                    window.location.href = `/letters/${nextLetter.toLowerCase()}/`;
                } else {
                    alert('The next letter is still locked! Check back in the coming weeks.');
                }
            }
        };
    });
</script>
{{ end }}
